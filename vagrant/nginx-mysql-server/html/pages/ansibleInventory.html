<!DOCTYPE html>

<html>
  <head>
    <link rel="stylesheet" href="../stylesheets/main.css" />
  </head>

  <body>
    <header>
      <div class="navbar">
        <div class="logo">
          <a href="../index.html">
            <svg
              class="fill-current sm:w-20 w-16"
              fill="none"
              height="78"
              viewBox="0 0 229 78"
              width="229"
              xmlns="http://www.w3.org/2000/svg"
            >
              <path
                d="M55.7568 8.69113C54.2925 7.56473 52.4851 6.96568 50.6368 7.00152H47.6672C41.1238 11.9116 33.961 15.9411 26.368 18.9823C18.8365 22.0851 11.7043 26.0684 5.12 30.8607C1.92512 33.7177 0.06656 37.7829 0 42.0735C0.37888 43.6965 1.52576 45.0329 3.072 45.6575C4.4544 46.1183 5.888 46.6815 7.2704 47.2447C21.2634 53.1839 34.4064 59.5686 46.6944 66.3935C48.3226 67.5762 49.8637 68.8767 51.3024 70.2847C52.2394 70.6943 53.248 70.9043 54.272 70.8991C56.7962 70.9196 59.2435 70.0492 61.184 68.4415C63.1552 67.0335 64.1997 64.6527 63.8976 62.2463C63.9795 60.4799 62.9299 58.8569 61.2864 58.2015L40.0896 48.8831C33.0547 45.8982 26.2195 42.478 19.6096 38.6431C24.2432 32.8729 30.4794 28.5977 37.5296 26.3551C44.5389 24.0972 51.0054 20.421 56.5248 15.5519C57.3184 14.789 57.7638 13.7343 57.7536 12.6335C57.7178 11.0873 56.9856 9.63321 55.7568 8.69113Z"
                fill="currentColor"
              ></path>
              <path
                d="M173.192 8.69113C174.657 7.56473 176.464 6.96568 178.312 7.00152H181.282C187.825 11.9116 194.988 15.9411 202.581 18.9823C210.112 22.0851 217.245 26.0684 223.829 30.8607C227.024 33.7177 228.882 37.7829 228.949 42.0735C228.57 43.6965 227.423 45.0329 225.877 45.6575C224.495 46.1183 223.061 46.6815 221.679 47.2447C207.686 53.1839 194.543 59.5686 182.255 66.3935C180.626 67.5762 179.085 68.8767 177.647 70.2847C176.71 70.6943 175.701 70.9043 174.677 70.8991C172.153 70.9196 169.705 70.0492 167.765 68.4415C165.794 67.0335 164.749 64.6527 165.051 62.2463C164.969 60.4799 166.019 58.8569 167.663 58.2015L188.859 48.8831C195.894 45.8982 202.729 42.478 209.339 38.6431C204.706 32.8729 198.47 28.5977 191.419 26.3551C184.41 24.0972 177.944 20.421 172.424 15.5519C171.631 14.789 171.185 13.7343 171.195 12.6335C171.231 11.0873 171.963 9.63321 173.192 8.69113Z"
                fill="currentColor"
              ></path>
              <path
                d="M93.3949 21.24C93.5946 21.24 93.7943 21.2451 93.9939 21.2502C94.1731 21.2451 94.3523 21.24 94.5264 21.24C97.752 21.24 100.916 22.1821 103.62 23.9638C107.367 27.5273 109.226 32.6474 108.637 37.7879C108.637 45.6215 106.384 50.8438 101.776 53.6086C99.4775 54.9091 96.8919 55.6106 94.25 55.6566C94.2397 55.6566 94.2346 55.6566 94.2243 55.6566C90.2051 55.6566 86.4164 53.7571 84.01 50.5366C81.1684 47.0704 79.3917 42.8566 78.89 38.4022C77.8557 33.6713 79.3251 28.7408 82.7811 25.3462C85.6893 22.6992 89.4781 21.24 93.3949 21.24ZM93.7892 42.4982C96.6154 42.4982 98.9092 40.2045 98.9092 37.3782C98.9092 34.552 96.6154 32.2582 93.7892 32.2582C90.9629 32.2582 88.6692 34.552 88.6692 37.3782C88.6692 40.2045 90.9629 42.4982 93.7892 42.4982ZM93.3949 11C86.9028 11 80.6871 13.4064 75.8896 17.7737C75.7923 17.8608 75.7002 17.9478 75.608 18.04C69.7303 23.8102 67.201 32.0022 68.7728 40.0509C69.5613 46.2205 72.0343 52.0163 75.9511 56.8598C80.2775 62.5226 87.0871 65.8966 94.2243 65.8966C98.7555 65.8198 103.041 64.6525 106.809 62.5277C106.886 62.4816 106.968 62.4355 107.045 62.3894C112.375 59.1894 118.713 52.4259 118.872 38.3357C119.604 30.2512 116.568 22.1462 110.675 16.545C110.235 16.1251 109.753 15.7462 109.246 15.4134C104.864 12.5309 99.7744 11.0051 94.5264 11.0051C94.3575 11.0051 94.1885 11.0051 94.0195 11.0102C93.8096 11 93.6048 11 93.3949 11Z"
                fill="currentColor"
                clip-rule="evenodd"
                fill-rule="evenodd"
              ></path>
              <path
                d="M103.62 23.9638C100.768 22.0899 97.4039 21.1376 93.9939 21.2502C89.8621 21.0915 85.8378 22.5661 82.7811 25.3462C79.3251 28.7408 77.8557 33.6713 78.89 38.4022C79.3917 42.8566 81.1684 47.0704 84.01 50.5366C86.4215 53.7674 90.2205 55.6669 94.25 55.6566C96.8919 55.6106 99.4775 54.9091 101.776 53.6086C106.384 50.8438 108.637 45.6215 108.637 37.7879C109.226 32.6474 107.367 27.5325 103.62 23.9638ZM93.7892 42.4982C90.9629 42.4982 88.6692 40.2045 88.6692 37.3782C88.6692 34.552 90.9629 32.2582 93.7892 32.2582C96.6154 32.2582 98.9092 34.552 98.9092 37.3782C98.9092 40.2045 96.6154 42.4982 93.7892 42.4982Z"
                fill="currentColor"
                clip-rule="evenodd"
                fill-rule="evenodd"
              ></path>
              <path
                d="M114.316 37.2695C114.316 48.0391 105.585 56.7695 94.8156 56.7695C84.046 56.7695 75.3156 48.0391 75.3156 37.2695C75.3156 26.5 84.046 17.7695 94.8156 17.7695C105.585 17.7695 114.316 26.5 114.316 37.2695Z"
                fill="currentColor"
              ></path>
              <path
                d="M149.112 31.671C148.297 38.2955 147.461 57.4944 147.273 67.341C147.232 69.5043 145.832 71.4364 143.676 71.6269C139.382 72.0066 133.814 71.3815 130.964 69.7944C129.748 68.6547 129.164 66.9933 129.396 65.3419C129.688 63.9143 129.917 62.3912 130.121 60.9124C131.974 45.8246 133.016 31.25 133.249 17.1958C133.039 15.1945 132.684 13.2095 132.184 11.2596C132.297 10.2434 132.62 9.26487 133.136 8.38062C134.381 6.1844 136.358 4.50014 138.721 3.62348C140.926 2.62037 143.51 2.90621 145.443 4.37102C147.013 5.18328 150.254 8.74899 150 10.5L149.112 31.671Z"
                fill="currentColor"
              ></path>
            </svg>
          </a>
        </div>
        <div class="navlinks">
          <a href="../index.html">Home</a>
          <a href="../pages/explore.html">Explore</a>
        </div>
      </div>
      <div class="banner">
        <div class="articleTags">
          <a href="">Ansible</a>
          <a href="">AWS Web Services</a>
          <a href="">DevOps</a>
        </div>
        <h1 style="font-size: 4.5em; padding: 0.5em 0">
          Load IP addresses for EC2 in Ansible Inventory
        </h1>
        <p>September 6, 2023.</p>
      </div>
    </header>
    <div class="articleContent">
      <p>
        Ansible is a great tool for automating infrastructure provisioning. It
        is agentless, which means that you don’t need to install anything on the
        target machine. It is also very easy to use and has a lot of modules
        that you can use to automate your infrastructure.
      </p>
      <p>
        Ansible inventory is a file that contains a list of hosts that Ansible
        can connect to. It is used to define the hosts that Ansible will connect
        to and the run the tasks on. This file can be either static i.e. you
        define the hosts manually or dynamic i.e. you define the hosts using a
        script. Given below is an example of a static inventory file.
      </p>
      <pre>
          <code>
              [web] <br>
              16.202.152.100 <br> 
              14.201.142.105
          </code>
          <code>
              [db] <br> 
              15.212.122.120
          </code>
      </pre>
      <p>
        As you can see, we have two groups <code>`[web]`</code> and
        <code>`[db]`</code> with each group having some IP addresses. The
        problem with this approach is that if you have a lot of hosts, then it
        becomes very difficult to manage the inventory file. Also, if you have a
        dynamic infrastructure where hosts are added and removed frequently,
        then it becomes even more difficult to manage the inventory file.
      </p>
      <p>
        In this article, we will learn how to dynamically populate the Ansible
        inventory with the IP address of EC2 instances.
      </p>
      <h3>Tagging EC2 instances</h3>
      <p>
        The first step to make it easier to manage the inventory file is to tag
        the EC2 instances properly. I normally tag the EC2 instances with the
        following tags at the very least:
      </p>
      <pre>
          <code>
              Project  =  "web-address.com" <br>
              Component  = "{COMPONENT}" <br>
              Role  = "{Role}" <br>
              Name  = "{COMPONENT}-{ROLE}-{ENVIRONMENT}" <br>
              Environment  = "{ENVIRONMENT}" <br>
              ManagedBy  = "{MANAGED_BY}"
          </code>
      </pre>
      <p>Details of what each tag means:</p>
      <ul>
        <li>
          <strong>Component:</strong>
          Name of the component if application consists of several different
          components e.g. <code>`newsletter`</code>, <code>`blog`</code>,
          <code>`app`</code>, etc.
        </li>
        <li>
          <strong>Role:</strong>
          Role of the EC2 instance e.g. <code>`api`</code> (backend API),
          <code>`web`</code> (customer facing app), <code>`db`</code> (database
          server), etc.
        </li>
        <li>
          <strong>Environment:</strong>
          Environment of the EC2 instance e.g. <code>`production`</code>,
          <code>`staging`</code>, <code>`development`</code>, etc.
        </li>
        <li>
          <strong>ManagedBy:</strong>
          How the EC2 instance is managed e.g. <code>`terraform`</code>,
          <code>`ansible`</code>, <code>`manual`</code>, etc.
        </li>
        <li>
          <strong>Name:</strong>
          This is the name of the EC2 instance. I normally use the following
          format: <code>`{COMPONENT}-{ROLE}-{ENVIRONMENT}`</code> e.g.
          <code>`app-api-production`</code>,
          <code>`newsletter-db-production`</code>,
          <code>`blog-web-staging`</code>, etc.
        </li>
      </ul>
      <p>
        Having these tags not only makes it easier to manage the inventory file
        but also makes it easier to manage the EC2 instances themselves e.g. you
        can easily find all the resources with specific tags, better analyse the
        cost of the infrastructure, etc.
      </p>
      <h3>Dynamic Inventory</h3>
      <p>
        There is an Ansible module called <code>`aws_ec2`</code> that can be
        used to dynamically populate the inventory file with the IP address of
        EC2 instances. It can get the IP address of EC2 instances based on the
        tags that we have defined above and give us hostnames that we can use in
        our playbooks. <a href="">It has a pretty decent documentation</a> that
        you can refer to to get an idea of usage but I will go through the usage
        here:
      </p>
      <p>
        First, we need to create a yaml file that will contain the configuration
        for the <code>`aws_ec2`</code> module. The filename must end with
        <code>`aws_ec2.yml`</code>, e.g. <code>``csfyi.aws_ec2.yml</code>. The
        contents of the file should be as follows:
      </p>
      <pre>
          <code>
            plugin: aws_ec2 <br>
            boto_profile: "{{ lookup('env', 'AWS_PROFILE') }}" <br>
            regions: <br>
            - ap-south-1 <br>
            filters: <br>
            instance-state-name: running <br>
            keyed_groups: <br>
            - key: tags.get('Component', 'unknown') + "_" + tags.get('Role', 'unknown') + "_" + tags.get('Environment', 'unknown') <br>
            separator: '' <br>
            - key: tags.get('Component', 'unknown') + "_" + tags.get('Role', 'unknown') <br>
            separator: ''
          </code>
      </pre>
      <p>Let's go through the configuration one by one:</p>
      <ul>
        <li>
          <strong>plugin:</strong>
          This is the name of the plugin that we are using. In our case, it is
          <code>`aws_ec2`</code>.
        </li>
        <li>
          <strong>boto_profile:</strong>
          This is the name of the AWS profile that we are using. We are using
          the value of the <code>`AWS_PROFILE`</code> environment variable here.
          This is useful if you have multiple AWS profiles configured on your
          machine.
        </li>
        <li>
          <strong>regions:</strong>
          This is the list of regions that we want to query for EC2 instances.
          In our case, we are only querying the
          <code>`ap-south-1`</code> region.
        </li>
        <li>
          <strong>filters:</strong>
          This is the list of filters that we want to apply to get the EC2
          instances in our inventory. In our case, we are only querying the
          running instances.
        </li>
        <li>
          <strong>keyed_groups:</strong>
          This is the list of filters that we want to apply to get the EC2
          instances in our inventory. In our case, we are only querying the
          running instances.
          <ul>
            <li>
              <code>`{COMPONENT}_{ROLE}_{ENVIRONMENT}`</code> e.g.
              <code>`app_api_production`</code>
              <code>`newsletter_db_production`</code>
              <code>`blog_web_staging`</code>, etc. This gives us the ability to
              run the playbooks on specific EC2 instances in a specific
              environment.
            </li>
            <li>
              <code>`{COMPONENT}_{ROLE}`</code>: e.g.
              <code>`app_api`</code>
              <code>`newsletter_db`</code>
              <code>`blog_web`</code>, etc. This gives the ability to run the
              playbooks regardless of the environment.
            </li>
          </ul>
        </li>
      </ul>
      <p>
        Once we have created the configuration file, we can use the
        <code>`aws_ec2`</code>
        module to get the list of EC2 instances. We can do this by running the
        following command:
      </p>
      <pre>
          <code>
            # Use --list or --graph to get the list of EC2 instances <br>
            ansible-inventory -i csfyi.aws_ec2.yml --list <br>
            ansible-inventory -i csfyi.aws_ec2.yml --graph
          </code>
          <code>
            # Add AWS_PROFILE if you are using multiple profiles in your machine <br>
            AWS_PROFILE=csfyi ansible-inventory -i csfyi.aws_ec2.yml --list
          </code>
          <code>
            # You can also use the following command to get the list of EC2 instances in a specific group <br>
            ansible-inventory -i csfyi.aws_ec2.yml --host ap p_api_production
          </code>
      </pre>
      <p>
        If all goes well, you should see the list of EC2 instances in the
        output. Now that we have the inventory file ready, we can use it in the
        <code>`ansible.cfg`</code> file. You should add the following lines to
        the <code>`ansible.cfg`</code>
        file:
      </p>
      <pre>
          <code>
            [defaults]
            # ...
            enable_plugins = aws_ec2
            inventory = ./roadmap.aws_ec2.yml
            # ...
          </code>
      </pre>
      <p>
        Now, you can use the host names in your playbooks. For example, if you
        want to run a playbook on all the EC2 instances in the
        <code>`app_api_production`</code> group, then you can do the following:
      </p>
      <pre>
          <code>
            - name: Configure draw.roadmap.sh
            hosts: app_api_production  # Name generated by the aws_ec2 plugin
            become: yes
            become_method: sudo
            gather_facts: no
            roles:
              - { role: base, tags: [ 'base' ] }
              - { role: nginx, tags: [ 'nginx' ] }
          </code>
      </pre>
      <h3>Conclusion</h3>
      <p>
        In this article, we learned how to dynamically populate the Ansible
        inventory with the IP address of EC2 instances. This makes it easier to
        manage the inventory file and also makes it easier to manage the EC2
        instances themselves. I hope you found this article useful.
      </p>
    </div>
    <footer>
      <div>&copy All rights reserved — cs.fyi</div>
    </footer>
  </body>
</html>
